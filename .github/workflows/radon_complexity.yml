name: Radon Code Complexity Analysis

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  analyze-complexity:
    name: Analyze Code Complexity
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install radon jq

      - name: Run Radon and generate report
        run: |
          run: |
          echo "## 游빑 Radon Complexity Report" >> $GITHUB_STEP_SUMMARY
          echo "| File | Function | Complexity | Rating |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Save raw JSON for reference
          radon cc src/api -a -nc --json > radon_output.json
          
          # Process JSON with Python instead of jq
          python3 -c '
          import json
          import sys
          
          def get_rating(complexity):
              if complexity < 5:
                  return "游릭 A"
              elif complexity < 10:
                  return "游릭 B"
              elif complexity < 20:
                  return "游리 C"
              elif complexity < 30:
                  return "游리 D"
              elif complexity < 40:
                  return "游댮 E"
              else:
                  return "游댮 F"
          
          with open("radon_output.json", "r") as f:
              data = json.load(f)
              
          for file_path, functions in data.items():
              for func in functions:
                  complexity = func.get("complexity", 0)
                  rating = get_rating(complexity)
                  print(f"| {file_path} | {func.get(\"name\")} | {complexity} | {rating} |")
          ' >> $GITHUB_STEP_SUMMARY
          
          # Add a count of functions found for verification
          echo "## Debug Information" >> $GITHUB_STEP_SUMMARY
          python3 -c '
          import json
          
          with open("radon_output.json", "r") as f:
              data = json.load(f)
              
          total = sum(len(functions) for functions in data.values())
          print(f"Total functions found: {total}")
          
          for file_path, functions in data.items():
              print(f"- {file_path}: {len(functions)} function(s)")
              for func in functions:
                  print(f"  - {func.get(\"name\")}: complexity {func.get(\"complexity\")}")
          ' >> $GITHUB_STEP_SUMMARY
      - name: Run Maintainability Index Report
        run: |
          echo "## 游늵 Maintainability Index Report" >> $GITHUB_STEP_SUMMARY
          echo "| File | Maintainability Index | Rank |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------------------|------|" >> $GITHUB_STEP_SUMMARY
          
          radon mi src/api --json | jq -r '
            to_entries[] |
            "| \(.key) | \(.value.mi) | \(.value.rank) |"
          ' >> $GITHUB_STEP_SUMMARY

      - name: Fail on high complexity (Optional)
        run: |
          MAX_COMPLEXITY=20
          EXIT_CODE=0
          echo "## 游뚿 High Complexity Functions Detected" >> $GITHUB_STEP_SUMMARY
          echo "| File | Function | Complexity | Rating |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          radon cc src/api -nc --json | jq -r '
            to_entries[] | 
            .key as $file | 
            .value[] | 
            select(.complexity > '"$MAX_COMPLEXITY"') |
            "| \($file) | \(.name) | \(.complexity) | " + 
            (if .complexity < 5 then "游릭 A"
             elif .complexity < 10 then "游릭 B"
             elif .complexity < 20 then "游리 C"
             elif .complexity < 30 then "游리 D"
             elif .complexity < 40 then "游댮 E"
             else "游댮 F" end) + " |"
          ' >> $GITHUB_STEP_SUMMARY
          
          if grep -q "游댮 F" $GITHUB_STEP_SUMMARY; then
            EXIT_CODE=1
          fi
          exit $EXIT_CODE
        continue-on-error: false
